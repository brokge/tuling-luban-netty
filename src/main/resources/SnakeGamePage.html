<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>欢迎来到图灵学院</title>
</head>
<body>

<canvas id="myCanvas" width="800" height="800" style="background: Black"></canvas>

<script type="text/javascript"
        src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>
<script type="text/javascript">
     // TODO 设置游戏状态
     // TODO 设置定时任务定时 检测版本
     // TODO 更新版本数据

    var websocket = null;
    var _top = 80;
    var index = 0;

    var host = window.location.host;
    var accountName = "";
    //判断当前浏览器是否支持WebSocket
    if ('WebSocket' in window) {
        websocket = new WebSocket("ws://" + host + "/ws");
        accountName = prompt("请输入你的游戏名称:", "我的小宝");
    }
    else {
        alert("Not Support WebSocket!");
    }


    //连接发生错误的回调方法
    websocket.onerror = function () {
    };

    //连接成功建立的回调方法
    websocket.onopen = function (event) {
        // 加入游戏
        websocket.send("JOIN:" + accountName);
    }

    //接收到消息的回调方法
    // 收到服务器发送的消息
    websocket.onmessage = function (event) {
        if (event.data != "[NULL]") {
            refresh(event.data);
        }
    }

    //连接关闭的回调方法
    websocket.onclose = function () {
    }


    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function () {
        websocket.close();
    }

    var canvas = document.getElementById('myCanvas');
    var ctx = canvas.getContext('2d');
    var size = 10;
    var version = 0;

    function draw(color, x, y) {
        ctx.fillStyle = color;
        ctx.fillRect(x * size, y * size, size, size);

    }

    document.onkeydown = function (e) {
        /* alert(e.keyCode)*/
        websocket.send("CONTROL:" + e.keyCode);
    };

    function refresh(data) {
        var lines = data.split("\r\n");
        lastVersion = parseInt(lines[0]);
        // 像素编码
        var cmds;
        for (var i = 1; i < lines.length; i++) {
            cmds = lines[i].split(",");
            for (var k = 1; k < cmds.length; k = k + 2) {
                draw(cmds[0], cmds[k], cmds[k + 1]);
            }
        }
    }
    // 推送版本
    function pushVersionData(data) {
        // 解析版本
    }
    // 版本更新检测
    function versionUpdateDetection() {
        /**
         * 全量更新逻辑
         * */
        var fullVersion = searchFullVersion();
        if (fullVersion != null && fullVersion.vData != null) { // 全量刷新界面
            refresh(fullVersion.vData);
            // 删除
            dataQueues.splice($.inArray(fullVersion, dataQueues), 1);
            return;
        } else if (lastVersion == 0 && fullVersion == null) {// 全量更新
            var vd = new VersionData(true);
            dataQueues.push(vd);
            websocket.send("FULL:true");
            return;
        } else if (fullVersion != null && fullVersion.vData == null) { // 等待全量更新
            return;
        }

        /**
         * 定量更新逻辑
         */
        // TODO 检测是否存在丢失版本，批量更新
        // TODO 丢失版本是否已超过10次，否则直接全量更新
        // TODO 等待定量更新完成超时需要重新定量更新
        if (lastVersion != 0) {
            var nextVersionNumber = lastVersion + 1;
            var nextVersion = searchVersion(nextVersionNumber);
            if (nextVersion != null && nextVersion.vData != null) { // 基于版本 刷新界面
                refresh(nextVersion.vData);
                return;
            } else if (nextVersion == null && $.now() - lastTime > 500) { //下个版本获取超时 定量更新
                nextVersion = new VersionData(false);
                nextVersion.version = nextVersionNumber;
                dataQueues.push(vd);
                websocket.send("QUANTITATIVE:" + (lastVersion + 1));
                return;
            } else if (nextVersion != null && nextVersion.vData == null) { // 等待定量更新完成
                return;
            }
        }
    }

    function searchFullVersion() {
        for (var i = 0; i < dataQueues.length; i++) {
            if (dataQueues[i].isFull) {
                return dataQueues[i];
            }
        }
    }
    function searchVersion(version) {
        for (var i = 0; i < dataQueues.length; i++) {
            if (dataQueues[i].version == version) {
                return dataQueues[i];
            }
        }
    }


    // 画面刷新算法
    var lastVersion = 0;
    var lastTime = 0;
    // 数据对列
    var dataQueues = new Array(10);

    // 读取更新画面
    function readFrames() {

    }

    function VersionData(isFull) {
        this.version = version; // 版本号
        this.vData = vData;   // 版本数据
        this.vTime = vTime; // 更新时间
        this.isFull = isFull;//是否为全量版本
        this.requestTime =$.now(); // 发起更新时间
    }


    //refresh("Lime,0,0,1,1,2,2\r\nYellow,4,4,5,5");
</script>
</body>
</html>