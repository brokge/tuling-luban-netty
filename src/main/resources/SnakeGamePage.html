<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>欢迎来到图灵学院</title>
</head>
<body>

<canvas id="myCanvas" width="800" height="800" style="background: Black"></canvas>


<script type="text/javascript">

    var websocket = null;
    var _top = 80;
    var index = 0;

    var host = window.location.host;
    var accountName="";
    //判断当前浏览器是否支持WebSocket
    if ('WebSocket' in window) {
        websocket = new WebSocket("ws://" + host + "/ws");
        accountName= prompt("请输入你的游戏名称:","我的小宝");
    }
    else {
        alert("Not Support WebSocket!");
    }


    //连接发生错误的回调方法
    websocket.onerror = function () {
    };

    //连接成功建立的回调方法
    websocket.onopen = function (event) {
        // 加入游戏
        websocket.send("JOIN:" + accountName);

    }

    //接收到消息的回调方法
    // 收到服务器发送的消息
    websocket.onmessage = function (event) {
        if (event.data != "[NULL]") {
            refresh(event.data);
        }
    }

    //连接关闭的回调方法
    websocket.onclose = function () {
    }


    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function () {
        websocket.close();
    }

    var canvas = document.getElementById('myCanvas');
    var ctx = canvas.getContext('2d');
    var size = 10;
    var version = 0;

    function draw(color, x, y) {
        ctx.fillStyle = color;
        ctx.fillRect(x * size, y * size, size, size);
    }

    document.onkeydown = function (e) {
        /* alert(e.keyCode)*/
        websocket.send("CONTROL:" + e.keyCode);
    };

    function refresh(data) {
        var lines = data.split("\r\n");
        lastVersion=parseInt(lines[0]);
        // 像素编码
        var cmds;
        for (var i = 1; i < lines.length; i++) {
            cmds = lines[i].split(",");
            for (var k = 1; k < cmds.length; k = k + 2) {
                draw(cmds[0], cmds[k], cmds[k + 1]);
            }
        }
    }

    // 画面刷新算法
    var lastVersion=0;

    // 数据对列
    var dataQueues=[];

    // 读取更新画面
    function readFrames() {

    }

    function VersionData(version,vData,vTime) {
            this.version=version;
            this.vData=vData;
            this.vTime =vTime;
    }

    //refresh("Lime,0,0,1,1,2,2\r\nYellow,4,4,5,5");
</script>
</body>
</html>